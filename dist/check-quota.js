#!/usr/bin/env ts-node
"use strict";var b=Object.create;var P=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var T=Object.getPrototypeOf,x=Object.prototype.hasOwnProperty;var I=(t,e,o,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let c of N(e))!x.call(t,c)&&c!==o&&P(t,c,{get:()=>e[c],enumerable:!(s=v(e,c))||s.enumerable});return t};var _=(t,e,o)=>(o=t!=null?b(T(t)):{},I(e||!t||!t.__esModule?P(o,"default",{value:t,enumerable:!0}):o,t));var C=require("child_process"),y=require("util"),h=_(require("https")),$=(0,y.promisify)(C.exec);async function q(){console.log("\u{1F680} \u5F00\u59CB\u83B7\u53D6 Codeium \u914D\u989D\u4FE1\u606F...");try{let t=process.platform==="darwin"?"language_server_macos":process.platform==="win32"?"language_server_windows_x64.exe":"language_server_linux";console.log(`\u{1F50D} \u6B63\u5728\u67E5\u627E\u8FDB\u7A0B: ${t}`);let e="";process.platform==="win32"?e=`wmic process where "name='${t}'" get commandline,processid /format:list`:e=`ps -ww -eo pid,args | grep "${t}" | grep -v grep`;let{stdout:o}=await $(e,{maxBuffer:1024*1024*5});if(!o.trim())throw new Error(`\u672A\u627E\u5230\u6B63\u5728\u8FD0\u884C\u7684 ${t} \u8FDB\u7A0B\uFF0C\u8BF7\u786E\u4FDD VS Code \u6216\u76F8\u5173\u5DE5\u5177\u6B63\u5728\u8FD0\u884C\u5E76\u5DF2\u767B\u5F55 Codeium\u3002`);let s=[];if(process.platform==="win32"){let a=o.trim().split(`\r
`).filter(p=>p.trim()),l="",m="";for(let p of a)if(p.startsWith("CommandLine="))l=p.substring(12);else if(p.startsWith("ProcessId=")){if(m=p.substring(10),l&&m){let g=l.match(/--csrf_token[=\s]+([a-f0-9\-]+)/i);g&&s.push({pid:parseInt(m,10),csrfToken:g[1]})}l="",m=""}}else{let a=o.trim().split(`
`);for(let l of a){let m=l.trim().split(/\s+/),p=parseInt(m[0],10),g=l.match(/--csrf_token[=\s]+([a-f0-9\-]+)/i);!isNaN(p)&&g&&s.push({pid:p,csrfToken:g[1]})}}if(s.length===0)throw new Error("\u672A\u53D1\u73B0\u4EFB\u4F55\u5E26\u6709 CSRF Token \u7684 Codeium \u8FDB\u7A0B\u3002");let c=Array.from(new Map(s.map(a=>[a.pid,a])).values());console.log(`\u2705 \u627E\u5230 ${c.length} \u4E2A\u6F5C\u5728\u8FDB\u7A0B: ${c.map(a=>a.pid).join(", ")}`),console.log("\u{1F50E} \u6B63\u5728\u626B\u63CF\u8FDB\u7A0B\u76D1\u542C\u7AEF\u53E3...");let n=(await Promise.all(c.map(async a=>{try{return(await E(a.pid)).map(m=>({port:m,token:a.csrfToken,pid:a.pid}))}catch{return[]}}))).flat();if(n.length===0)throw console.error(`
\u274C \u6240\u6709\u68C0\u6D4B\u5230\u7684\u8FDB\u7A0B\u5747\u672A\u53D1\u73B0\u672C\u5730\u76D1\u542C\u7AEF\u53E3\u3002\u8FD9\u53EF\u80FD\u662F\u56E0\u4E3A\uFF1A`),console.error("   1. lsof/netstat/ss \u547D\u4EE4\u6743\u9650\u4E0D\u8DB3 (\u5C1D\u8BD5 sudo?)"),console.error("   2. \u8FDB\u7A0B\u76D1\u542C\u7AEF\u53E3\u7684\u65B9\u5F0F\u672A\u88AB\u811A\u672C\u6355\u83B7"),console.error("   3. \u60A8\u5728\u67D0\u4E9B\u4E0D\u80FD\u76F4\u63A5\u8BBF\u95EE\u7AEF\u53E3\u7684\u8FDC\u7A0B\u5F00\u53D1\u73AF\u5883"),new Error("\u6240\u6709\u5019\u9009\u8FDB\u7A0B\u5747\u672A\u53D1\u73B0\u7AEF\u53E3\u3002");let i=Array.from(new Set(n.map(a=>a.port)));console.log(`\u{1F4E1} \u53D1\u73B0 ${i.length} \u4E2A\u5019\u9009\u7AEF\u53E3: ${i.join(", ")}\uFF0C\u5E76\u884C\u63A2\u6D4B\u53EF\u7528\u6027...`);let u=i.map(async a=>{let l=n.find(p=>p.port===a);return l&&await A(a,l.token)?{port:a,token:l.token}:null}),f=(await Promise.all(u)).find(a=>a!==null);if(!f)throw new Error("\u672A\u80FD\u627E\u5230\u53EF\u7528\u7684 API \u54CD\u5E94\u7AEF\u53E3\u3002");let{port:w,token:S}=f;console.log(`\u2728 \u786E\u5B9A\u5DE5\u4F5C\u7AEF\u53E3: ${w}\uFF0C\u6B63\u5728\u83B7\u53D6\u914D\u989D\u6570\u636E...`);let k=await D(w,S);L(k)}catch(t){console.error(`
\u274C \u51FA\u9519\u4E86: ${t.message}`),process.exit(1)}}async function E(t){let e="",o=[];process.platform==="darwin"?o.push({name:"lsof",cmd:`lsof -Pan -p ${t} -i`}):process.platform==="win32"?o.push({name:"netstat",cmd:`netstat -ano | findstr LISTENING | findstr ${t}`}):(o.push({name:"ss",cmd:`ss -tlnp | grep "pid=${t},"`}),o.push({name:"netstat",cmd:`netstat -tulpn | grep ${t}`}),o.push({name:"lsof",cmd:`lsof -Pan -p ${t} -i`}));for(let{name:c,cmd:r}of o)try{let{stdout:n}=await $(r);if(n.trim()){e=n;break}}catch{}let s=[];if(e){let c=e.split(`
`);for(let r of c){let n=r.match(/(?:127\.0\.0\.1|localhost|0\.0\.0\.0|\[::1\]|\*):(\d+)/);if(n&&n[1]){let i=parseInt(n[1],10);s.includes(i)||s.push(i)}}}return s}async function A(t,e){return new Promise(o=>{let s=JSON.stringify({metadata:{ideName:"node-script"}}),r=h.request({hostname:"127.0.0.1",port:t,path:"/exa.language_server_pb.LanguageServerService/GetUnleashData",method:"POST",headers:{"Content-Type":"application/json","X-Codeium-Csrf-Token":e,"Connect-Protocol-Version":"1"},rejectUnauthorized:!1,timeout:1e3},n=>{o(n.statusCode===200),n.resume()});r.on("error",()=>o(!1)),r.on("timeout",()=>{r.destroy(),o(!1)}),r.write(s),r.end()})}async function D(t,e){return new Promise((o,s)=>{let c=JSON.stringify({metadata:{ideName:"antigravity",extensionName:"antigravity",locale:"en"}}),n=h.request({hostname:"127.0.0.1",port:t,path:"/exa.language_server_pb.LanguageServerService/GetUserStatus",method:"POST",headers:{"Content-Type":"application/json","X-Codeium-Csrf-Token":e,"Connect-Protocol-Version":"1"},rejectUnauthorized:!1},i=>{let u="";i.on("data",d=>u+=d),i.on("end",()=>{if(i.statusCode===200)try{o(JSON.parse(u))}catch{s(new Error("\u89E3\u6790\u54CD\u5E94 JSON \u5931\u8D25"))}else s(new Error(`API \u8BF7\u6C42\u5931\u8D25: ${i.statusCode}`))})});n.on("error",s),n.write(c),n.end()})}function L(t){let e=t.userStatus,o=e.planStatus,s=o?.planInfo,c=e.cascadeModelConfigData?.clientModelConfigs||[];if(console.log(`
`+"=".repeat(40)),console.log(`\u{1F464} \u7528\u6237: ${e.name} (${e.email})`),console.log(`\u{1F4E6} \u5957\u9910: ${s?.planName||"Unknown"}`),console.log("=".repeat(40)),o?.availablePromptCredits!==void 0){let r=s?.monthlyPromptCredits||0,n=o.availablePromptCredits,i=r>0?(n/r*100).toFixed(1):"N/A";console.log(`\u{1F4B3} \u603B\u914D\u989D (Prompt Credits): ${n} / ${r} (${i}%)`)}console.log(`
\u{1F916} \u6A21\u578B\u8BE6\u60C5\u914D\u989D:`),console.log("-".repeat(40));for(let r of c)if(r.quotaInfo){let n=r.label,i=r.quotaInfo.remainingFraction??0,u=(i*100).toFixed(1),d=new Date(r.quotaInfo.resetTime).toLocaleString(),f="\u{1F7E2}";i<=0?f="\u26AB":i<=.3?f="\u{1F534}":i<=.5&&(f="\u{1F7E1}"),console.log(`${f} ${n.padEnd(20)} | \u5269\u4F59: ${u.padStart(5)}% | \u91CD\u7F6E\u65F6\u95F4: ${d}`)}console.log("=".repeat(40)+`
`)}require.main===module&&q().catch(t=>{console.error(`
\u274C Fatal Error: ${t.message}`),process.exit(1)});
